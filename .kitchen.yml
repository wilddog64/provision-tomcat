---
driver:
  name: vagrant
  driver: virtualbox

provisioner:
  require_chef_omnibus: false
  name: ansible_playbook
  hosts: test-kitchen
  require_ansible_repo: true
  playbook: tests/playbook.yml
  roles_path: ..
  ansible_version: latest
  host_key_checking: false
  ansible_galaxy_role_file: requirements.yml
  # vault_password_file: ./secrets/my_pass.txt
  idempotency_test: false
  chef_bootstrap_url: null
  verbose: vv
  extra_vars:
    env: stage2
    extract_build_number: 16
    extract_debug: 'False'
    skip_migration: true

platforms:
  - name: ubuntu-2404
    driver_config:
      box: hashicorp-education/ubuntu-24-04
  - name: rockylinux9
    driver_config:
      box: bento/rockylinux-9
  - name: win11
    driver_config:
      box: stromweld/windows-11
      communicator: winrm
    transport:
      name: winrm
      elevated: true
      ssl_peer_verification: false
      port: 5985
      winrm_transport: :plaintext
      ssl: false
      connection_retries: 5
      connection_retry_sleep: 10
    provisioner:
      name: ansible_push
      ansible_playbook_bin: <%= Dir.glob("#{Dir.pwd}/.direnv/python-*/bin/ansible-playbook").first %>
      hosts: test-kitchen
      require_ansible_repo: true
      playbook: tests/playbook.yml
      roles_path: ..
      ansible_version: latest
      ansible_host_key_checking: false
      ansible_galaxy_role_file: requirements.yml
      idempotency_test: false
      chef_bootstrap_url: null
      ansible_verbosity: 2
      require_windows_support: true
      extra_vars:
        env: stage2
        extract_build_number: 16
        extract_debug: 'False'
        skip_migration: true
        ansible_connection: winrm
        ansible_winrm_transport: basic
        ansible_port: 5985
        ansible_winrm_scheme: http
        ansible_winrm_server_cert_validation: ignore
        ansible_user: vagrant
        ansible_password: vagrant
        ansible_host: 127.0.0.1
  - name: win11-disk
    driver:
      provision: true  # Run Vagrant provisioners (disk_setup) during kitchen create
    driver_config:
      box: stromweld/windows-11
      communicator: winrm
      vagrantfiles:
        - /Users/cliang/src/gitrepo/personal/ansible/provision-tomcat/vagrant/Vagrantfile-disk.rb
    transport:
      name: winrm
      elevated: true
      ssl_peer_verification: false
      port: 5985
      winrm_transport: :plaintext
      ssl: false
      connection_retries: 5
      connection_retry_sleep: 10
    provisioner:
      name: ansible_push
      ansible_playbook_bin: <%= Dir.glob("#{Dir.pwd}/.direnv/python-*/bin/ansible-playbook").first %>
      hosts: test-kitchen
      require_ansible_repo: true
      playbook: tests/playbook.yml
      roles_path: ..
      ansible_version: latest
      ansible_host_key_checking: false
      ansible_galaxy_role_file: requirements.yml
      idempotency_test: false
      chef_bootstrap_url: null
      ansible_verbosity: 2
      require_windows_support: true
      extra_vars:
        env: stage2
        extract_build_number: 16
        extract_debug: 'False'
        skip_migration: true
        ansible_connection: winrm
        ansible_winrm_transport: basic
        ansible_port: 5985
        ansible_winrm_scheme: http
        ansible_winrm_server_cert_validation: ignore
        ansible_user: vagrant
        ansible_password: vagrant
        ansible_host: 127.0.0.1
        install_drive: "D:"

  - name: win11-baseline
    driver_config:
      box: windows11-tomcat112
      communicator: winrm
    transport:
      name: winrm
      elevated: true
      ssl_peer_verification: false
      port: 5985
      winrm_transport: :plaintext
      ssl: false
      connection_retries: 5
      connection_retry_sleep: 10
    provisioner:
      name: ansible_push
      ansible_playbook_bin: <%= Dir.glob("#{Dir.pwd}/.direnv/python-*/bin/ansible-playbook").first %>
      hosts: test-kitchen
      require_ansible_repo: true
      playbook: tests/playbook.yml
      roles_path: ..
      ansible_version: latest
      ansible_host_key_checking: false
      ansible_galaxy_role_file: requirements.yml
      idempotency_test: false
      chef_bootstrap_url: null
      ansible_verbosity: 2
      require_windows_support: true
      extra_vars:
        env: stage2
        extract_build_number: 16
        extract_debug: 'False'
        skip_migration: true
        ansible_connection: winrm
        ansible_winrm_transport: basic
        ansible_port: 5985
        ansible_winrm_scheme: http
        ansible_winrm_server_cert_validation: ignore
        ansible_user: vagrant
        ansible_password: vagrant
        ansible_host: 127.0.0.1

suites:
  - name: default
    driver:
      network:
        - ["forwarded_port", {guest: 8080, host: 8080, auto_correct: true}]
    provisioner:
      extra_vars:
        tomcat_version: "9.0.113"
        tomcat_auto_start: true
    verifier:
      name: shell
      command: |
        # Verify port forwarding is working (Ansible playbook handles service verification)
        curl --connect-timeout 5 --max-time 10 -f http://localhost:8080 || curl --connect-timeout 5 --max-time 10 http://localhost:8080 | grep -q "404"

  - name: upgrade
    driver:
      network:
        - ["forwarded_port", {guest: 8080, host: 8080, auto_correct: true}]
    provisioner:
      playbook: tests/playbook-upgrade.yml
      extra_vars:
        upgrade_step: 1
        tomcat_auto_start: true
    verifier:
      name: shell
      command: |
        # Verify port forwarding is working
        curl --connect-timeout 5 --max-time 10 -f http://localhost:8080 || curl --connect-timeout 5 --max-time 10 http://localhost:8080 | grep -q "404"

  - name: downgrade
    driver:
      network:
        - ["forwarded_port", {guest: 8080, host: 8080, auto_correct: true}]
    provisioner:
      playbook: tests/playbook-downgrade.yml
      extra_vars:
        downgrade_step: 1
        tomcat_auto_start: true
    verifier:
      name: shell
      command: |
        # Verify port forwarding is working
        curl --connect-timeout 5 --max-time 10 -f http://localhost:8080 || curl --connect-timeout 5 --max-time 10 http://localhost:8080 | grep -q "404"

  - name: idempotence
    driver:
      network:
        - ["forwarded_port", {guest: 8080, host: 8080, auto_correct: true}]
    provisioner:
      extra_vars:
        tomcat_version: "9.0.113"
        tomcat_auto_start: true
      idempotency_test: true
    verifier:
      name: shell
      command: |
        # Verify port forwarding is working
        curl --connect-timeout 5 --max-time 10 -f http://localhost:8080 || curl --connect-timeout 5 --max-time 10 http://localhost:8080 | grep -q "404"

  - name: no-autostart
    provisioner:
      extra_vars:
        tomcat_version: "9.0.113"
        tomcat_auto_start: false
    verifier:
      name: shell
      command: |
        # No verification needed - Ansible playbook handles service state checks
        exit 0
  - name: upgrade-baseline
    driver:
      network:
        - ["forwarded_port", {guest: 8080, host: 8080, auto_correct: true}]
        - ["forwarded_port", {guest: 9080, host: 9080, auto_correct: true}]
    provisioner:
      playbook: tests/playbook-upgrade.yml
      extra_vars:
        upgrade_step: 2
        tomcat_auto_start: true
        tomcat_candidate_enabled: true
        tomcat_candidate_delegate: localhost
    verifier:
      name: shell
      command: |
        curl --connect-timeout 5 --max-time 10 -f http://localhost:8080 || curl --connect-timeout 5 --max-time 10 http://localhost:8080 | grep -q "404"
