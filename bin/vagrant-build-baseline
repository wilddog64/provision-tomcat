#!/bin/bash
# Build a Vagrant box with D: drive, optionally with Tomcat + JDK pre-installed.
#
# Usage:
#   ./vagrant-build-baseline              # Full: D: drive + Tomcat + Java
#   ./vagrant-build-baseline --disk-only  # Minimal: D: drive only
#
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

DISK_SIZE_GB="${VAGRANT_DISK_SIZE_GB:-50}"
DISK_ONLY=false

# Parse arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    --disk-only|--minimal)
      DISK_ONLY=true
      shift
      ;;
    -h|--help)
      cat <<EOF
Usage: $(basename "$0") [OPTIONS]

Build a Vagrant baseline box with D: drive.

Options:
  --disk-only, --minimal  Build minimal box with D: drive only (no Tomcat/Java)
  -h, --help              Show this help message

Environment variables:
  VAGRANT_DISK_SIZE_GB    Size of D: drive in GB (default: 50)
EOF
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      exit 1
      ;;
  esac
done

# Set output box name based on mode
if [[ "$DISK_ONLY" == "true" ]]; then
  OUTPUT_BOX="boxes/windows11-disk.box"
  BOX_NAME="windows11-disk"
else
  OUTPUT_BOX="boxes/windows11-tomcat9.0.112-java17.box"
  BOX_NAME="windows11-tomcat112"
fi

run_cmd() {
  if command -v direnv >/dev/null 2>&1 && [[ -f .envrc ]]; then
    direnv exec . "$@"
  else
    "$@"
  fi
}

mkdir -p "$(dirname "$OUTPUT_BOX")"

if [[ -f "$OUTPUT_BOX" ]]; then
  read -r -p "Box $OUTPUT_BOX already exists. Overwrite? [y/N] " answer
  case "$answer" in
    [Yy]*) rm -f "$OUTPUT_BOX" ;;
    *) echo "Aborted."; exit 1 ;;
  esac
fi

# Clean up any existing disk file
rm -f .vagrant/data_disk.vdi

echo "==> Creating VM with ${DISK_SIZE_GB}GB D: drive..."
run_cmd vagrant up --no-provision

echo "==> Setting up D: drive..."
run_cmd vagrant provision --provision-with disk_setup

if [[ "$DISK_ONLY" == "false" ]]; then
  echo "==> Installing Tomcat and Java..."
  run_cmd vagrant provision --provision-with ansible_upgrade_step1
fi

echo "==> Packaging box..."
run_cmd vagrant halt

# Detach secondary disk before packaging (it's not included in the box anyway)
# This prevents "VERR_FILE_NOT_FOUND" errors during export
echo "    Detaching secondary disk from VM..."
VM_ID=$(cat .vagrant/machines/default/virtualbox/id 2>/dev/null || true)
if [[ -n "$VM_ID" ]]; then
  VBoxManage storageattach "$VM_ID" --storagectl "SATA Controller" --port 1 --device 0 --medium none 2>/dev/null || true
fi

# Clean up the disk file and VirtualBox registration
DISK_FILE="$ROOT_DIR/.vagrant/data_disk.vdi"
if [[ -f "$DISK_FILE" ]]; then
  # Get UUID and close medium
  DISK_UUID=$(VBoxManage showmediuminfo "$DISK_FILE" 2>/dev/null | grep "^UUID:" | awk '{print $2}' || true)
  if [[ -n "$DISK_UUID" ]]; then
    VBoxManage closemedium disk "$DISK_UUID" --delete 2>/dev/null || true
  else
    rm -f "$DISK_FILE"
  fi
fi
# Also clean up any stale registration without file
./bin/vbox-cleanup-disks 2>/dev/null || true

# Note: The secondary disk is NOT included in the packaged box by default.
# The box will have the D: drive configured but empty on first use.
run_cmd vagrant package --output "$OUTPUT_BOX"

echo "==> Adding box to Vagrant..."
# Remove existing box if present (cleanup stale box)
if vagrant box list | grep -q "^${BOX_NAME} "; then
  echo "    Removing existing box: $BOX_NAME"
  vagrant box remove "$BOX_NAME" --all --force 2>/dev/null || true
fi

# Add the new box
vagrant box add "$BOX_NAME" "$OUTPUT_BOX"

cat <<MSG

Baseline box created and added: $BOX_NAME

The box is now ready to use. You can verify with:
  vagrant box list | grep $BOX_NAME

Note: The D: drive configuration is included, but the disk itself is created
fresh on first 'vagrant up'. Run 'vagrant provision --provision-with disk_setup'
to initialize the D: drive on new instances.
MSG
