---
- block:
  - name: Normalize Tomcat chocolatey args
    set_fact:
      tomcat_effective_choco_args: >-
        {{ (tomcat_choco_args | default([])) + (['--force'] if tomcat_force_install | bool else []) }}

  - name: Verify Java is installed (using fact from provision-java role)
    assert:
      that:
        - java_home is defined
        - java_home | length > 0
      fail_msg: "Java is not installed. Ensure provision-java role ran successfully."
      success_msg: "Java verified at {{ java_home }}"

  - name: Check if Tomcat service exists and is properly installed
    ansible.windows.win_service_info:
      name: "{{ tomcat_service_name }}"
    register: tomcat_service_check

  - name: Set fact for whether Tomcat is properly installed
    set_fact:
      tomcat_properly_installed: >-
        {{ (tomcat_service_check.services | default([])) | length > 0 }}

  - name: Display current Tomcat installation status
    debug:
      msg: >-
        {% if tomcat_properly_installed %}
        Tomcat service already exists - will ensure it is running (no reinstall)
        {% else %}
        Tomcat not found - will install
        {% endif %}

  - name: Install Tomcat via Chocolatey
    win_chocolatey:
      name: "{{ tomcat_package_name }}"
      state: present
      choco_args: "{{ tomcat_effective_choco_args | join(' ') if (tomcat_effective_choco_args | length > 0) else omit }}"
    register: tomcat_installation
    when: not tomcat_properly_installed or (tomcat_force_install | default(false))

  - name: Wait for Tomcat service to exist (initial install)
    ansible.windows.win_service_info:
      name: "{{ tomcat_service_name }}"
    register: tomcat_service_after_install
    retries: 10
    delay: 5
    until: (tomcat_service_after_install.services | default([])) | length > 0
    when: tomcat_installation.changed | default(false)

  - name: Ensure Tomcat service is started
    ansible.windows.win_service:
      name: "{{ tomcat_service_name }}"
      state: started
    retries: 5
    delay: 10
    register: tomcat_service_start
    until: tomcat_service_start is succeeded
    failed_when: false

  - name: Verify Tomcat service status
    ansible.windows.win_service_info:
      name: "{{ tomcat_service_name }}"
    register: tomcat_final_status

  - name: Display Tomcat service status
    debug:
      msg: "Tomcat service state: {{ tomcat_final_status.services[0].state | default('unknown') }}, status: {{ tomcat_final_status.services[0].status | default('unknown') }}"
    when:
      - tomcat_final_status is defined
      - (tomcat_final_status.services | default([])) | length > 0

  - name: Tomcat installation complete
    debug:
      msg: "Tomcat installation complete. Access via http://localhost:8080 (check post_tasks for verification)"

  become: no
