---
# Playbook to test Tomcat upgrade scenarios
# First run: Install older version
# Second run: Upgrade to newer version
- name: Test Tomcat/Java upgrade scenarios
  hosts: all
  become: no

  vars:
    # Install paths - override with -e install_drive=D: to use D: drive
    install_drive: "C:"
    java_install_base_dir: "{{ install_drive }}/java"
    tomcat_install_dir: "{{ install_drive }}/Tomcat"
    java_temp_dir: "{{ install_drive }}/temp"
    tomcat_temp_dir: "{{ install_drive }}/temp"

    # Test overrides for security roles (since no domain controller)
    security_service_account: "svcTomcat"
    security_jenkins_accounts:
      - "svclabbuild"
      - "svcjenkins"
    security_admin_groups: []

  pre_tasks:
    - name: Gather facts
      ansible.builtin.setup:
      tags:
        - always

    - name: Create local test accounts
      ansible.windows.win_user:
        name: "{{ item }}"
        password: "Password123!"
        password_never_expires: true
        state: present
        groups:
          - Users
      loop:
        - svcTomcat
        - svclabbuild
        - svcjenkins
      when: ansible_facts['os_family'] == 'Windows'
      tags:
        - always

    - name: Debug install_drive value
      debug:
        msg: "install_drive = '{{ install_drive }}', os_family = '{{ ansible_facts['os_family'] | default('unknown') }}'"
      tags:
        - always

    # Initialize D: drive if needed (for win11-disk platform)
    - name: "Initialize D: drive if RAW disk exists"
      ansible.windows.win_powershell:
        script: |
          # First check if D: already exists
          if (Test-Path "D:\") {
            Write-Host "D: drive already exists"
            $Ansible.Changed = $false
            return
          }

          $disk = Get-Disk | Where-Object PartitionStyle -eq 'RAW'
          if ($disk) {
            Write-Host "Initializing and formatting D: drive..."
            $disk | Initialize-Disk -PartitionStyle GPT -PassThru |
              New-Partition -DriveLetter D -UseMaximumSize |
              Format-Volume -FileSystem NTFS -NewFileSystemLabel "Data" -Confirm:$false
            Write-Host "D: drive created successfully"
            $Ansible.Changed = $true
          } else {
            Write-Host "No RAW disk found - listing all disks for debugging:"
            Get-Disk | Format-Table -AutoSize
            $Ansible.Changed = $false
          }
      when:
        - ansible_facts['os_family'] == 'Windows'
        - install_drive is defined
        - install_drive == 'D:'
      tags:
        - always

  tasks:
    - name: Determine which version to install based on run number
      set_fact:
        # First converge (if upgrade_step not defined): install old version
        # Second converge (upgrade_step=2): install new version
        tomcat_version: "{{ '9.0.112' if (upgrade_step | default(1) | int) == 1 else '9.0.113' }}"
        jdk_version: "{{ '17' if (upgrade_step | default(1) | int) == 1 else '21' }}"
      tags:
        - always

    - name: Display installation plan
      debug:
        msg: |
          Upgrade step: {{ upgrade_step | default(1) }}
          Installing Tomcat: {{ tomcat_version }}
          Installing Java: {{ jdk_version }}
      tags:
        - always

    # Base configuration and Agents
    - name: Include windows-base role
      include_role:
        name: windows-base

    # Security configuration
    - name: Include provision-windows-security role
      include_role:
        name: provision-windows-security

    # Install Java
    - name: Include provision-java role
      include_role:
        name: provision-java

    # Install Tomcat
    - name: Include provision-tomcat role
      include_role:
        name: provision-tomcat

    - name: Display installation summary
      debug:
        msg: |
          Installation complete for upgrade step {{ upgrade_step | default(1) }}
          Tomcat version: {{ tomcat_version }}
          Java version: {{ jdk_version }}
          {% if (upgrade_step | default(1) | int) == 1 %}
          Next: Run again with -e upgrade_step=2 to test upgrade
          {% else %}
          Upgrade test complete!
          {% endif %}
      tags:
        - always
