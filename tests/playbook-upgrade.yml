---
# Playbook to test Tomcat upgrade scenarios
# First run: Install older version
# Second run: Upgrade to newer version
- name: Test Tomcat/Java upgrade scenarios
  hosts: all
  become: no

  vars:
    # Install paths - override with install_drive to use D: drive
    install_drive: "{{ install_drive | default('C:') }}"
    java_install_base_dir: "{{ install_drive }}/java"
    tomcat_install_dir: "{{ install_drive }}/Tomcat"
    java_temp_dir: "{{ install_drive }}/temp"
    tomcat_temp_dir: "{{ install_drive }}/temp"

  tasks:
    - name: Determine which version to install based on run number
      set_fact:
        # First converge (if upgrade_step not defined): install old version
        # Second converge (upgrade_step=2): install new version
        tomcat_version: "{{ '9.0.112' if (upgrade_step | default(1) | int) == 1 else '9.0.113' }}"
        jdk_version: "{{ '17' if (upgrade_step | default(1) | int) == 1 else '21' }}"
      tags:
        - always

    - name: Display installation plan
      debug:
        msg: |
          Upgrade step: {{ upgrade_step | default(1) }}
          Installing Tomcat: {{ tomcat_version }}
          Installing Java: {{ jdk_version }}
      tags:
        - always

    # Install Java
    - name: Include provision-java role
      include_role:
        name: provision-java

    # Install Tomcat
    - name: Include provision-tomcat role
      include_role:
        name: provision-tomcat

    - name: Display installation summary
      debug:
        msg: |
          Installation complete for upgrade step {{ upgrade_step | default(1) }}
          Tomcat version: {{ tomcat_version }}
          Java version: {{ jdk_version }}
          {% if (upgrade_step | default(1) | int) == 1 %}
          Next: Run again with -e upgrade_step=2 to test upgrade
          {% else %}
          Upgrade test complete!
          {% endif %}
      tags:
        - always
